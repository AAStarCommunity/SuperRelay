# SuperRelay ç”¨æˆ·æµ‹è¯•ç”¨ä¾‹

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æœ¬æ–‡æ¡£åŒ…å«SuperRelayæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½çš„ç”¨æˆ·æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–ç”¨æˆ·è§†è§’ã€äº§å“æ–¹æ¡ˆè§†è§’å’Œç³»ç»Ÿè§†è§’çš„å®Œæ•´æµ‹è¯•åœºæ™¯ã€‚

## ğŸ¯ æµ‹è¯•ç»´åº¦

### ç”¨æˆ·è§†è§’æµ‹è¯•
éªŒè¯æœ€ç»ˆç”¨æˆ·ä½¿ç”¨ä½“éªŒå’ŒåŠŸèƒ½å¯ç”¨æ€§

### äº§å“æ–¹æ¡ˆè§†è§’æµ‹è¯•
éªŒè¯ä¸šåŠ¡æµç¨‹å’Œäº§å“ä»·å€¼å®ç°

### ç³»ç»Ÿè§†è§’æµ‹è¯•
éªŒè¯æŠ€æœ¯æ¶æ„å’Œç³»ç»Ÿç¨³å®šæ€§

---

## ğŸ§ª æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ç”¨ä¾‹

### TC001: Gas Sponsorship åŸºç¡€æµç¨‹

**æµ‹è¯•ç›®æ ‡**: éªŒè¯åŸºç¡€gasèµåŠ©åŠŸèƒ½
**æµ‹è¯•çº§åˆ«**: ç”¨æˆ·è§†è§’ + äº§å“æ–¹æ¡ˆè§†è§’

**å‰ç½®æ¡ä»¶**:
- SuperRelayæœåŠ¡è¿è¡Œæ­£å¸¸
- Paymasterè´¦æˆ·æœ‰å……è¶³ETHä½™é¢
- æµ‹è¯•ç½‘ç»œ(Anvil)è¿è¡Œä¸­

**æµ‹è¯•æ­¥éª¤**:
1. ç”¨æˆ·æ„é€ UserOperationè¯·æ±‚
2. è°ƒç”¨ `pm_sponsorUserOperation` API
3. ç³»ç»ŸéªŒè¯UserOperationæœ‰æ•ˆæ€§
4. Paymasterç­¾åå¹¶è¿”å›sponsorshipæ•°æ®
5. ç”¨æˆ·æäº¤å®Œæ•´UserOperationåˆ°ç½‘ç»œ

**é¢„æœŸç»“æœ**:
- APIè¿”å›æˆåŠŸå“åº”åŒ…å«paymasterå­—æ®µ
- UserOperationåœ¨åŒºå—é“¾ä¸ŠæˆåŠŸæ‰§è¡Œ
- Gasè´¹ç”¨ç”±Paymasteræ‰¿æ‹…

**éªŒè¯å‘½ä»¤**:
```bash
# 1. å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
./scripts/start_anvil.sh
./scripts/start_dev_server.sh

# 2. æ‰§è¡Œsponsorshipæµ‹è¯•
./scripts/test_simple.sh

# 3. éªŒè¯ç»“æœ
curl -X POST http://localhost:3000 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"pm_sponsorUserOperation","params":[{...}],"id":1}'
```

---

### TC002: Policy Engine è®¿é—®æ§åˆ¶

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç­–ç•¥å¼•æ“æ­£ç¡®è¿‡æ»¤è¯·æ±‚
**æµ‹è¯•çº§åˆ«**: äº§å“æ–¹æ¡ˆè§†è§’ + ç³»ç»Ÿè§†è§’

**å‰ç½®æ¡ä»¶**:
- é…ç½®ç­–ç•¥æ–‡ä»¶ `config/paymaster-policies.toml`
- è®¾ç½®ç™½åå•/é»‘åå•è§„åˆ™

**æµ‹è¯•åœºæ™¯**:

**2.1 ç™½åå•æµ‹è¯•**
- ç™½åå•åœ°å€è¯·æ±‚sponsorship â†’ åº”è¯¥æˆåŠŸ
- éç™½åå•åœ°å€è¯·æ±‚ â†’ åº”è¯¥è¢«æ‹’ç»

**2.2 Gasé™åˆ¶æµ‹è¯•**
- æ­£å¸¸gasé™åˆ¶è¯·æ±‚ â†’ åº”è¯¥æˆåŠŸ
- è¶…å‡ºgasé™åˆ¶è¯·æ±‚ â†’ åº”è¯¥è¢«æ‹’ç»

**2.3 é€Ÿç‡é™åˆ¶æµ‹è¯•**
- æ­£å¸¸é¢‘ç‡è¯·æ±‚ â†’ åº”è¯¥æˆåŠŸ
- é«˜é¢‘æ”»å‡»è¯·æ±‚ â†’ åº”è¯¥è¢«é™åˆ¶

**éªŒè¯æ–¹æ³•**:
```bash
# ç¼–è¾‘ç­–ç•¥æ–‡ä»¶
vim config/paymaster-policies.toml

# é‡å¯æœåŠ¡ä½¿ç­–ç•¥ç”Ÿæ•ˆ
./scripts/restart_super_relay.sh

# æµ‹è¯•ä¸åŒç­–ç•¥åœºæ™¯
./scripts/test_policy_engine.sh
```

---

### TC003: Multi-Version EntryPoint å…¼å®¹æ€§

**æµ‹è¯•ç›®æ ‡**: éªŒè¯v0.6å’Œv0.7 EntryPointæ”¯æŒ
**æµ‹è¯•çº§åˆ«**: ç³»ç»Ÿè§†è§’

**æµ‹è¯•åœºæ™¯**:
- **v0.6æµ‹è¯•**: ä½¿ç”¨EntryPoint v0.6åˆçº¦æµ‹è¯•å®Œæ•´æµç¨‹
- **v0.7æµ‹è¯•**: ä½¿ç”¨EntryPoint v0.7åˆçº¦æµ‹è¯•å®Œæ•´æµç¨‹
- **å¹¶å‘æµ‹è¯•**: åŒæ—¶å¤„ç†v0.6å’Œv0.7è¯·æ±‚

**éªŒè¯å‘½ä»¤**:
```bash
# è¿è¡Œv0.6å…¼å®¹æ€§æµ‹è¯•
./test/spec-tests/local/run-spec-tests-v0_6.sh

# è¿è¡Œv0.7å…¼å®¹æ€§æµ‹è¯•
./test/spec-tests/local/run-spec-tests-v0_7.sh

# è¿è¡Œå¹¶å‘æµ‹è¯•
./scripts/test_multi_version.sh
```

---

### TC004: API å®Œæ•´æ€§å’Œæ–‡æ¡£ä¸€è‡´æ€§

**æµ‹è¯•ç›®æ ‡**: éªŒè¯APIåŠŸèƒ½å’ŒSwaggeræ–‡æ¡£ä¸€è‡´æ€§
**æµ‹è¯•çº§åˆ«**: ç”¨æˆ·è§†è§’ + ç³»ç»Ÿè§†è§’

**æµ‹è¯•å†…å®¹**:
1. **Swagger UIå¯è®¿é—®æ€§**
   - è®¿é—® http://localhost:9000/swagger-ui/
   - æ‰€æœ‰APIç«¯ç‚¹å¯æ­£å¸¸æ˜¾ç¤ºå’Œæµ‹è¯•

2. **JSON-RPC APIå®Œæ•´æ€§**
   - æ ‡å‡†ERC-4337æ–¹æ³•: `eth_sendUserOperation`, `eth_estimateUserOperationGas`
   - Paymasteræ‰©å±•æ–¹æ³•: `pm_sponsorUserOperation`, `pm_getPaymasterData`
   - ç®¡ç†æ–¹æ³•: `admin_clearMempool`, `debug_bundlerClearState`

3. **REST APIå¥åº·æ£€æŸ¥**
   - `/health` ç«¯ç‚¹è¿”å›æœåŠ¡çŠ¶æ€
   - `/metrics` ç«¯ç‚¹è¿”å›PrometheusæŒ‡æ ‡

**éªŒè¯è„šæœ¬**:
```bash
# APIå®Œæ•´æ€§æµ‹è¯•
./scripts/test_api_completeness.sh

# Swaggeræ–‡æ¡£éªŒè¯
curl http://localhost:9000/swagger-ui/ | grep -i "SuperRelay"
```

---

### TC005: æ€§èƒ½å’Œå‹åŠ›æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
**æµ‹è¯•çº§åˆ«**: ç³»ç»Ÿè§†è§’

**æ€§èƒ½è¦æ±‚**:
- RPCå“åº”æ—¶é—´: < 200ms (p95)
- å¹¶å‘å¤„ç†: >= 100 RPS
- å†…å­˜ä½¿ç”¨: < 500MB ç¨³æ€
- é”™è¯¯ç‡: < 0.1%

**æµ‹è¯•åœºæ™¯**:

**5.1 å•ç”¨æˆ·æ€§èƒ½æµ‹è¯•**
```bash
# æµ‹è¯•å•ä¸ªRPCè°ƒç”¨å»¶è¿Ÿ
time curl -X POST http://localhost:3000 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}'
```

**5.2 å¹¶å‘å‹åŠ›æµ‹è¯•**
```bash
# ä½¿ç”¨abè¿›è¡Œå‹åŠ›æµ‹è¯•
ab -n 1000 -c 50 -T 'application/json' \
   -p test_payload.json \
   http://localhost:3000/

# æˆ–ä½¿ç”¨ä¸“ç”¨è„šæœ¬
./scripts/test_performance.sh
```

**5.3 å†…å­˜æ³„æ¼æµ‹è¯•**
```bash
# é•¿æœŸè¿è¡Œç›‘æ§å†…å­˜ä½¿ç”¨
./scripts/test_memory_leak.sh
```

---

### TC006: å®‰å…¨æ€§æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç³»ç»Ÿå®‰å…¨æ€§
**æµ‹è¯•çº§åˆ«**: ç³»ç»Ÿè§†è§’ + äº§å“æ–¹æ¡ˆè§†è§’

**å®‰å…¨æµ‹è¯•å†…å®¹**:

**6.1 ç§é’¥å®‰å…¨æµ‹è¯•**
```bash
# ç¡®ä¿æ²¡æœ‰ç¡¬ç¼–ç ç§é’¥
./scripts/security_check.sh

# æ£€æŸ¥æ—¥å¿—ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
grep -r "private" logs/ | grep -v "INFO\|DEBUG"
```

**6.2 è¾“å…¥éªŒè¯æµ‹è¯•**
- æ¶æ„UserOperationè¯·æ±‚ â†’ åº”è¯¥è¢«æ‹’ç»
- è¶…é•¿è¾“å…¥æ•°æ® â†’ åº”è¯¥è¢«æ­£ç¡®å¤„ç†
- æ— æ•ˆç­¾åæ•°æ® â†’ åº”è¯¥è¢«æ£€æµ‹

**6.3 DDoSé˜²æŠ¤æµ‹è¯•**
```bash
# é«˜é¢‘è¯·æ±‚æ”»å‡»æµ‹è¯•
./scripts/test_ddos_protection.sh

# éªŒè¯é€Ÿç‡é™åˆ¶ç”Ÿæ•ˆ
curl -X POST http://localhost:3000 -d '...' # é‡å¤æ‰§è¡Œ
```

---

### TC007: å®¹é”™å’Œæ¢å¤æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç³»ç»Ÿå®¹é”™èƒ½åŠ›
**æµ‹è¯•çº§åˆ«**: ç³»ç»Ÿè§†è§’

**æ•…éšœåœºæ™¯**:

**7.1 ç½‘ç»œæ•…éšœæµ‹è¯•**
- EthereumèŠ‚ç‚¹è¿æ¥ä¸­æ–­ â†’ ç³»ç»Ÿåº”è¯¥ä¼˜é›…é™çº§
- æ¢å¤è¿æ¥å â†’ ç³»ç»Ÿåº”è¯¥è‡ªåŠ¨æ¢å¤

**7.2 èµ„æºä¸è¶³æµ‹è¯•**
- Paymasterä½™é¢ä¸è¶³ â†’ è¿”å›æ˜ç¡®é”™è¯¯ä¿¡æ¯
- ç³»ç»Ÿå†…å­˜ä¸è¶³ â†’ åº”è¯¥æœ‰é€‚å½“çš„é™æµ

**7.3 é…ç½®é”™è¯¯æµ‹è¯•**
- é”™è¯¯çš„é…ç½®æ–‡ä»¶ â†’ å¯åŠ¨æ—¶æŠ¥é”™å¹¶é€€å‡º
- è¿è¡Œæ—¶é…ç½®ä¿®æ”¹ â†’ åº”è¯¥åŠ¨æ€ç”Ÿæ•ˆ

**éªŒè¯æ–¹æ³•**:
```bash
# ç½‘ç»œæ•…éšœæ¨¡æ‹Ÿ
./scripts/test_network_failure.sh

# èµ„æºé™åˆ¶æµ‹è¯•
./scripts/test_resource_limits.sh
```

---

## ğŸ“Š æµ‹è¯•æ‰§è¡Œè®¡åˆ’

### è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹
```bash
# å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œ
make test-all

# åˆ†ç±»æµ‹è¯•æ‰§è¡Œ
make test-unit          # å•å…ƒæµ‹è¯•
make test-integration   # é›†æˆæµ‹è¯•
make test-spec          # è§„èŒƒæµ‹è¯•
make test-performance   # æ€§èƒ½æµ‹è¯•
make test-security      # å®‰å…¨æµ‹è¯•
```

### æ‰‹å·¥æµ‹è¯•æ£€æŸ¥æ¸…å•

**éƒ¨ç½²å‰æ£€æŸ¥** âœ…:
- [ ] æ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡
- [ ] å®‰å…¨æ‰«ææ— é«˜å±é—®é¢˜
- [ ] æ€§èƒ½æŒ‡æ ‡æ»¡è¶³è¦æ±‚
- [ ] APIæ–‡æ¡£å®Œæ•´å‡†ç¡®
- [ ] ç›‘æ§å’Œæ—¥å¿—æ­£å¸¸

**ç”¨æˆ·éªŒæ”¶æµ‹è¯•** âœ…:
- [ ] Demoæµç¨‹å®Œæ•´å¯ç”¨
- [ ] Swagger UIå¯æ­£å¸¸ä½¿ç”¨
- [ ] é”™è¯¯ä¿¡æ¯ç”¨æˆ·å‹å¥½
- [ ] å“åº”æ—¶é—´æ»¡è¶³é¢„æœŸ

## ğŸ” æµ‹è¯•ç»“æœè¯„åˆ¤æ ‡å‡†

### é€šè¿‡æ ‡å‡†
- æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹100%é€šè¿‡
- æ€§èƒ½æŒ‡æ ‡è¾¾åˆ°è®¾è®¡è¦æ±‚
- å®‰å…¨æ‰«ææ— å…³é”®é—®é¢˜
- ç”¨æˆ·ä½“éªŒæ»¡è¶³é¢„æœŸ

### å¤±è´¥å¤„ç†
- è®°å½•å¤±è´¥åŸå› å’Œå¤ç°æ­¥éª¤
- åˆ†é…ç»™ç›¸å…³å¼€å‘äººå‘˜ä¿®å¤
- ä¿®å¤åé‡æ–°æ‰§è¡Œæµ‹è¯•
- æ›´æ–°æµ‹è¯•ç”¨ä¾‹é¿å…å›å½’

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

æ¯æ¬¡æµ‹è¯•æ‰§è¡Œåç”ŸæˆæŠ¥å‘Š:
```
æµ‹è¯•æ—¶é—´: YYYY-MM-DD HH:MM:SS
æµ‹è¯•ç‰ˆæœ¬: v0.1.x
æµ‹è¯•ç¯å¢ƒ: å¼€å‘/æµ‹è¯•/ç”Ÿäº§

æ‰§è¡Œç»“æœ:
- æ€»ç”¨ä¾‹æ•°: XX
- é€šè¿‡ç”¨ä¾‹: XX
- å¤±è´¥ç”¨ä¾‹: XX
- è·³è¿‡ç”¨ä¾‹: XX

æ€§èƒ½æŒ‡æ ‡:
- å¹³å‡å“åº”æ—¶é—´: XXXms
- æœ€é«˜QPS: XXX
- å†…å­˜ä½¿ç”¨: XXXMb

é—®é¢˜åˆ—è¡¨:
- é—®é¢˜1: æè¿°åŠå½±å“
- é—®é¢˜2: æè¿°åŠå½±å“

å»ºè®®:
- æ”¹è¿›å»ºè®®1
- æ”¹è¿›å»ºè®®2
```